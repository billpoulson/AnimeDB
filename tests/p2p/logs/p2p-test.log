
========================================
  AnimeDB P2P Integration Test
  Sun Mar  1 02:17:22 UTC 2026
========================================

[1] Waiting for nodes...
  NodeA is ready
  NodeB is ready
  NodeC is ready

[2] Verifying instance identity...

──────────────────────────────────────
REQUEST #1  02:17:22
GET http://nodea:3000/api/networking
RESPONSE: HTTP 200
{
  "instanceId": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "instanceName": "NodeA",
  "externalUrl": "http://nodea:3000",
  "upnp": {
    "active": false,
    "externalIp": null,
    "externalPort": null,
    "error": null
  }
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #1  02:17:22
GET http://nodeb:3000/api/networking
RESPONSE: HTTP 200
{
  "instanceId": "653040fd-dec6-45f0-bcce-7312d7db4313",
  "instanceName": "NodeB",
  "externalUrl": "http://nodeb:3000",
  "upnp": {
    "active": false,
    "externalIp": null,
    "externalPort": null,
    "error": null
  }
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #1  02:17:22
GET http://nodec:3000/api/networking
RESPONSE: HTTP 200
{
  "instanceId": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
  "instanceName": "NodeC",
  "externalUrl": "http://nodec:3000",
  "upnp": {
    "active": false,
    "externalIp": null,
    "externalPort": null,
    "error": null
  }
}
──────────────────────────────────────
  PASS: NodeA instance name
  PASS: NodeB instance name
  PASS: NodeC instance name
  PASS: NodeA instance ID
  PASS: NodeB instance ID
  PASS: NodeC instance ID
  PASS: NodeA external URL
  PASS: NodeB external URL
  PASS: NodeC external URL
  PASS: All instance IDs are unique

[3] Creating API keys...

──────────────────────────────────────
REQUEST #1  02:17:23
POST http://nodea:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"test-key-for-B"}
RESPONSE: HTTP 201
{
  "id": "b92222b6-6aeb-4880-907e-6791318580c3",
  "label": "test-key-for-B",
  "key": "adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWE6MzAwMCIsIm5hbWUiOiJOb2RlQSIsImtleSI6ImFkYl9jNGFlOWRjNTEzN2I2YTc3MjVkZWE3NzBhZDcxMDJlN2I1NWIwNTRiZTNkMTBkZGI0ZWVmYWU3NWNhNjQxMDlkIn0="
}
──────────────────────────────────────
  PASS: NodeA key generated

──────────────────────────────────────
REQUEST #1  02:17:23
POST http://nodeb:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"test-key-for-A"}
RESPONSE: HTTP 201
{
  "id": "0a5fc520-8b07-46fa-8ef5-9477b13a4d5c",
  "label": "test-key-for-A",
  "key": "adb_bbee51b7e3b5025d33bb92ea5c26c953b71ed66788979ea5bf757894e46df5fe",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWI6MzAwMCIsIm5hbWUiOiJOb2RlQiIsImtleSI6ImFkYl9iYmVlNTFiN2UzYjUwMjVkMzNiYjkyZWE1YzI2Yzk1M2I3MWVkNjY3ODg5NzllYTViZjc1Nzg5NGU0NmRmNWZlIn0="
}
──────────────────────────────────────
  PASS: NodeB key generated

──────────────────────────────────────
REQUEST #1  02:17:23
GET http://nodea:3000/api/keys
RESPONSE: HTTP 200
[
  {
    "id": "b92222b6-6aeb-4880-907e-6791318580c3",
    "label": "test-key-for-B",
    "created_at": "2026-03-01 02:17:23"
  }
]
──────────────────────────────────────
  PASS: NodeA has 1 key listed
  PASS: Listed key does not expose raw key

[4] Testing federation auth...

──────────────────────────────────────
REQUEST #1  02:17:23
GET http://nodea:3000/api/federation/library
RESPONSE: HTTP 401
{
  "error": "Missing or invalid Authorization header"
}
──────────────────────────────────────
  PASS: No auth returns 401

──────────────────────────────────────
REQUEST #1  02:17:23
GET http://nodea:3000/api/federation/library
  Header: Authorization: Bearer bad_key
RESPONSE: HTTP 401
{
  "error": "Invalid API key"
}
──────────────────────────────────────
  PASS: Bad key returns 401

──────────────────────────────────────
REQUEST #1  02:17:23
GET http://nodea:3000/api/federation/library
  Header: Authorization: Bearer adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d
RESPONSE: HTTP 200
{
  "instanceId": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "instanceName": "NodeA",
  "items": []
}
──────────────────────────────────────
  PASS: Valid key returns 200

[5] Checking federation library response...

──────────────────────────────────────
REQUEST #1  02:17:23
GET http://nodea:3000/api/federation/library
  Header: Authorization: Bearer adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d
RESPONSE: HTTP 200
{
  "instanceId": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "instanceName": "NodeA",
  "items": []
}
──────────────────────────────────────
  PASS: Federation returns instance name
  PASS: Federation returns instance ID
  PASS: Library is empty initially

[6] Adding peers...

──────────────────────────────────────
REQUEST #1  02:17:23
POST http://nodeb:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeA","url":"http://nodea:3000","api_key":"adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d"}
RESPONSE: HTTP 201
{
  "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
  "name": "NodeA",
  "url": "http://nodea:3000",
  "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53"
}
──────────────────────────────────────
  PASS: Peer A added on B
  PASS: Peer stores NodeA's instance ID

──────────────────────────────────────
REQUEST #1  02:17:24
POST http://nodea:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeB","url":"http://nodeb:3000","api_key":"adb_bbee51b7e3b5025d33bb92ea5c26c953b71ed66788979ea5bf757894e46df5fe"}
RESPONSE: HTTP 201
{
  "id": "64d3cc8e-9efa-4457-8365-f5602c110b91",
  "name": "NodeB",
  "url": "http://nodeb:3000",
  "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313"
}
──────────────────────────────────────
  PASS: Peer B added on A
  PASS: Peer stores NodeB's instance ID

[7] Browsing peer library...

──────────────────────────────────────
REQUEST #1  02:17:24
GET http://nodeb:3000/api/peers/65d9354d-40da-4819-bb6d-bf0d18a2e026/library
RESPONSE: HTTP 200
{
  "instanceId": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "instanceName": "NodeA",
  "items": []
}
──────────────────────────────────────
  PASS: Browse returns NodeA's name
  PASS: Browse returns 0 items (empty library)

[8] Verifying peer listings...

──────────────────────────────────────
REQUEST #1  02:17:24
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:23",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:23"
  }
]
──────────────────────────────────────
  PASS: NodeB has 1 peer
  PASS: Peer has instance_id
  PASS: Peer has last_seen
  PASS: Peer listing hides api_key

[8b] Testing auto-sync PATCH...

──────────────────────────────────────
REQUEST #1  02:17:24
PATCH http://nodeb:3000/api/peers/65d9354d-40da-4819-bb6d-bf0d18a2e026
  Header: Content-Type: application/json
  Body: {"auto_replicate":true}
RESPONSE: HTTP 200
{
  "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
  "name": "NodeA",
  "url": "http://nodea:3000",
  "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "last_seen": "2026-03-01 02:17:23",
  "auto_replicate": 1,
  "sync_library_id": null,
  "created_at": "2026-03-01 02:17:23"
}
──────────────────────────────────────
  PASS: PATCH enables auto_replicate
  PASS: sync_library_id is null when not set

──────────────────────────────────────
REQUEST #1  02:17:24
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:23",
    "auto_replicate": 1,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:23"
  }
]
──────────────────────────────────────
  PASS: GET peers returns auto_replicate

──────────────────────────────────────
REQUEST #1  02:17:24
PATCH http://nodeb:3000/api/peers/65d9354d-40da-4819-bb6d-bf0d18a2e026
  Header: Content-Type: application/json
  Body: {"auto_replicate":false}
RESPONSE: HTTP 200
{
  "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
  "name": "NodeA",
  "url": "http://nodea:3000",
  "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "last_seen": "2026-03-01 02:17:23",
  "auto_replicate": 0,
  "sync_library_id": null,
  "created_at": "2026-03-01 02:17:23"
}
──────────────────────────────────────
  PASS: PATCH disables auto_replicate

[9] Testing announce...

──────────────────────────────────────
REQUEST #1  02:17:24
POST http://nodeb:3000/api/federation/announce
  Header: Authorization: Bearer adb_bbee51b7e3b5025d33bb92ea5c26c953b71ed66788979ea5bf757894e46df5fe
  Header: Content-Type: application/json
  Body: {"instanceId":"a793cc16-a57d-4070-878d-5f75ebaaeb53","url":"http://nodea-new:9999"}
RESPONSE: HTTP 200
{
  "updated": true
}
──────────────────────────────────────
  PASS: Announce updates peer URL

──────────────────────────────────────
REQUEST #1  02:17:25
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
    "name": "NodeA",
    "url": "http://nodea-new:9999",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:24",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:23"
  }
]
──────────────────────────────────────
  PASS: Peer URL updated after announce

──────────────────────────────────────
REQUEST #1  02:17:25
POST http://nodeb:3000/api/federation/announce
  Header: Authorization: Bearer adb_bbee51b7e3b5025d33bb92ea5c26c953b71ed66788979ea5bf757894e46df5fe
  Header: Content-Type: application/json
  Body: {"instanceId":"a793cc16-a57d-4070-878d-5f75ebaaeb53","url":"http://nodea:3000"}
RESPONSE: HTTP 200
{
  "updated": true
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #2  02:17:25
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "65d9354d-40da-4819-bb6d-bf0d18a2e026",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:25",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:23"
  }
]
──────────────────────────────────────
  PASS: Peer URL restored

[10] Testing resolve...

──────────────────────────────────────
REQUEST #2  02:17:25
GET http://nodea:3000/api/federation/resolve/653040fd-dec6-45f0-bcce-7312d7db4313
  Header: Authorization: Bearer adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d
RESPONSE: HTTP 200
{
  "instanceId": "653040fd-dec6-45f0-bcce-7312d7db4313",
  "name": "NodeB",
  "url": "http://nodeb:3000",
  "lastSeen": "2026-03-01 02:17:24"
}
──────────────────────────────────────
  PASS: Resolve returns NodeB's URL
  PASS: Resolve returns NodeB's name

[11] Testing networking endpoint...

──────────────────────────────────────
REQUEST #2  02:17:25
GET http://nodea:3000/api/networking
RESPONSE: HTTP 200
{
  "instanceId": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
  "instanceName": "NodeA",
  "externalUrl": "http://nodea:3000",
  "upnp": {
    "active": false,
    "externalIp": null,
    "externalPort": null,
    "error": null
  }
}
──────────────────────────────────────
  PASS: Networking returns instance ID
  PASS: Networking returns external URL

[12] Testing external URL override...

──────────────────────────────────────
REQUEST #2  02:17:25
PUT http://nodea:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":"http://custom.example.com:3000"}
RESPONSE: HTTP 200
{
  "externalUrl": "http://custom.example.com:3000"
}
──────────────────────────────────────
  PASS: External URL set

──────────────────────────────────────
REQUEST #2  02:17:25
PUT http://nodea:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":null}
RESPONSE: HTTP 200
{
  "externalUrl": null
}
──────────────────────────────────────
  PASS: External URL cleared

──────────────────────────────────────
REQUEST #2  02:17:25
PUT http://nodea:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":"http://nodea:3000"}
RESPONSE: HTTP 200
{
  "externalUrl": "http://nodea:3000"
}
──────────────────────────────────────

[13] Testing key revocation...

──────────────────────────────────────
REQUEST #3  02:17:25
DELETE http://nodea:3000/api/keys/b92222b6-6aeb-4880-907e-6791318580c3
RESPONSE: HTTP 204
──────────────────────────────────────

──────────────────────────────────────
REQUEST #4  02:17:25
GET http://nodea:3000/api/federation/library
  Header: Authorization: Bearer adb_c4ae9dc5137b6a7725dea770ad7102e7b55b054be3d10ddb4eefae75ca64109d
RESPONSE: HTTP 401
{
  "error": "Invalid API key"
}
──────────────────────────────────────
  PASS: Revoked key returns 401

──────────────────────────────────────
REQUEST #4  02:17:26
POST http://nodea:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"replacement-key"}
RESPONSE: HTTP 201
{
  "id": "e2106ecc-f55d-4138-8f46-431f2d99bf53",
  "label": "replacement-key",
  "key": "adb_6f4dff40aa311ce698a6c23063215c4c98b1bdf86d471f849ea34bbab89a3a98",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWE6MzAwMCIsIm5hbWUiOiJOb2RlQSIsImtleSI6ImFkYl82ZjRkZmY0MGFhMzExY2U2OThhNmMyMzA2MzIxNWM0Yzk4YjFiZGY4NmQ0NzFmODQ5ZWEzNGJiYWI4OWEzYTk4In0="
}
──────────────────────────────────────
  PASS: Replacement key created

[14] Testing peer deletion...

──────────────────────────────────────
REQUEST #4  02:17:26
DELETE http://nodeb:3000/api/peers/65d9354d-40da-4819-bb6d-bf0d18a2e026
RESPONSE: HTTP 204
──────────────────────────────────────
  PASS: Peer deleted returns 204

──────────────────────────────────────
REQUEST #4  02:17:26
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[]
──────────────────────────────────────
  PASS: NodeB has 0 peers after delete

[15] Setting up 3-node mesh...

──────────────────────────────────────
REQUEST #4  02:17:26
DELETE http://nodea:3000/api/peers/64d3cc8e-9efa-4457-8365-f5602c110b91
RESPONSE: HTTP 204
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodea:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"mesh-key"}
RESPONSE: HTTP 201
{
  "id": "deeacc8d-59e6-4a7a-a55c-84826fa303df",
  "label": "mesh-key",
  "key": "adb_5273adc4c6376f396b32ad5f43720ee4110311e845a297755e474f125459fb10",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWE6MzAwMCIsIm5hbWUiOiJOb2RlQSIsImtleSI6ImFkYl81MjczYWRjNGM2Mzc2ZjM5NmIzMmFkNWY0MzcyMGVlNDExMDMxMWU4NDVhMjk3NzU1ZTQ3NGYxMjU0NTlmYjEwIn0="
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodeb:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"mesh-key"}
RESPONSE: HTTP 201
{
  "id": "1580f790-46d2-422d-b6ac-4120b64f4e30",
  "label": "mesh-key",
  "key": "adb_c62350f9b820d52e04edad0d3f3a6bfebff0f544b1b33e54e2408e1f9e80964f",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWI6MzAwMCIsIm5hbWUiOiJOb2RlQiIsImtleSI6ImFkYl9jNjIzNTBmOWI4MjBkNTJlMDRlZGFkMGQzZjNhNmJmZWJmZjBmNTQ0YjFiMzNlNTRlMjQwOGUxZjllODA5NjRmIn0="
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodec:3000/api/keys
  Header: Content-Type: application/json
  Body: {"label":"mesh-key"}
RESPONSE: HTTP 201
{
  "id": "a37c7eb4-5e96-4084-bf95-4068af87fbc8",
  "label": "mesh-key",
  "key": "adb_e9c260ffe1a3a199d86891863920aeddd1ce669f2a1300b0f68b0b1f2f9f4eee",
  "connectionString": "adb-connect:eyJ1cmwiOiJodHRwOi8vbm9kZWM6MzAwMCIsIm5hbWUiOiJOb2RlQyIsImtleSI6ImFkYl9lOWMyNjBmZmUxYTNhMTk5ZDg2ODkxODYzOTIwYWVkZGQxY2U2NjlmMmExMzAwYjBmNjhiMGIxZjJmOWY0ZWVlIn0="
}
──────────────────────────────────────
  PASS: Mesh key A created
  PASS: Mesh key B created
  PASS: Mesh key C created

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodea:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeB","url":"http://nodeb:3000","api_key":"adb_c62350f9b820d52e04edad0d3f3a6bfebff0f544b1b33e54e2408e1f9e80964f"}
RESPONSE: HTTP 201
{
  "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
  "name": "NodeB",
  "url": "http://nodeb:3000",
  "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodea:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeC","url":"http://nodec:3000","api_key":"adb_e9c260ffe1a3a199d86891863920aeddd1ce669f2a1300b0f68b0b1f2f9f4eee"}
RESPONSE: HTTP 201
{
  "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
  "name": "NodeC",
  "url": "http://nodec:3000",
  "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14"
}
──────────────────────────────────────
  PASS: A linked to B
  PASS: A linked to C

──────────────────────────────────────
REQUEST #5  02:17:26
POST http://nodeb:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeA","url":"http://nodea:3000","api_key":"adb_5273adc4c6376f396b32ad5f43720ee4110311e845a297755e474f125459fb10"}
RESPONSE: HTTP 201
{
  "id": "4f5eecda-6787-4ee7-8b25-cac64b9c67d3",
  "name": "NodeA",
  "url": "http://nodea:3000",
  "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:27
POST http://nodeb:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeC","url":"http://nodec:3000","api_key":"adb_e9c260ffe1a3a199d86891863920aeddd1ce669f2a1300b0f68b0b1f2f9f4eee"}
RESPONSE: HTTP 201
{
  "id": "b6efc81b-2744-4dee-8c1e-bc307f910b57",
  "name": "NodeC",
  "url": "http://nodec:3000",
  "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14"
}
──────────────────────────────────────
  PASS: B linked to A
  PASS: B linked to C

──────────────────────────────────────
REQUEST #5  02:17:27
POST http://nodec:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeA","url":"http://nodea:3000","api_key":"adb_5273adc4c6376f396b32ad5f43720ee4110311e845a297755e474f125459fb10"}
RESPONSE: HTTP 201
{
  "id": "a9283a0b-7ad9-4381-9036-ea074fea924d",
  "name": "NodeA",
  "url": "http://nodea:3000",
  "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:27
POST http://nodec:3000/api/peers
  Header: Content-Type: application/json
  Body: {"name":"NodeB","url":"http://nodeb:3000","api_key":"adb_c62350f9b820d52e04edad0d3f3a6bfebff0f544b1b33e54e2408e1f9e80964f"}
RESPONSE: HTTP 201
{
  "id": "c2f3ac66-03e1-4b4f-b463-abb9720400b3",
  "name": "NodeB",
  "url": "http://nodeb:3000",
  "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313"
}
──────────────────────────────────────
  PASS: C linked to A
  PASS: C linked to B

──────────────────────────────────────
REQUEST #5  02:17:27
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:27
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "b6efc81b-2744-4dee-8c1e-bc307f910b57",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:27",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  },
  {
    "id": "4f5eecda-6787-4ee7-8b25-cac64b9c67d3",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────

──────────────────────────────────────
REQUEST #5  02:17:27
GET http://nodec:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "a9283a0b-7ad9-4381-9036-ea074fea924d",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:27",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  },
  {
    "id": "c2f3ac66-03e1-4b4f-b463-abb9720400b3",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:27",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  }
]
──────────────────────────────────────
  PASS: A has 2 peers
  PASS: B has 2 peers
  PASS: C has 2 peers

──────────────────────────────────────
REQUEST #5  02:17:27
GET http://nodea:3000/api/peers/a205d1d9-a84e-4c3a-9536-2925d4c8f261/library
RESPONSE: HTTP 200
{
  "instanceId": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
  "instanceName": "NodeC",
  "items": []
}
──────────────────────────────────────
  PASS: A can browse C's library

[16] Simulating node offline + address change...

──────────────────────────────────────
REQUEST #5  02:17:27
PUT http://nodec:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":"http://nodec-new:5000"}
RESPONSE: HTTP 200
{
  "externalUrl": "http://nodec-new:5000"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #6  02:17:28
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec-new:5000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:27",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: A has C's new URL after announce

──────────────────────────────────────
REQUEST #6  02:17:28
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "b6efc81b-2744-4dee-8c1e-bc307f910b57",
    "name": "NodeC",
    "url": "http://nodec-new:5000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:27",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  },
  {
    "id": "4f5eecda-6787-4ee7-8b25-cac64b9c67d3",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: B has C's new URL after announce

──────────────────────────────────────
REQUEST #6  02:17:28
PUT http://nodec:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":"http://nodec-final:4000"}
RESPONSE: HTTP 200
{
  "externalUrl": "http://nodec-final:4000"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #7  02:17:30
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec-final:4000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:29",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: A tracks C's final URL

──────────────────────────────────────
REQUEST #7  02:17:30
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "b6efc81b-2744-4dee-8c1e-bc307f910b57",
    "name": "NodeC",
    "url": "http://nodec-final:4000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:29",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  },
  {
    "id": "4f5eecda-6787-4ee7-8b25-cac64b9c67d3",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: B tracks C's final URL

──────────────────────────────────────
REQUEST #7  02:17:30
PUT http://nodec:3000/api/networking/external-url
  Header: Content-Type: application/json
  Body: {"url":"http://nodec:3000"}
RESPONSE: HTTP 200
{
  "externalUrl": "http://nodec:3000"
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #8  02:17:31
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:30",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: A has C's restored URL

[17] Testing gossip resolve with stale record...

──────────────────────────────────────
REQUEST #8  02:17:31
POST http://nodea:3000/api/federation/announce
  Header: Authorization: Bearer adb_5273adc4c6376f396b32ad5f43720ee4110311e845a297755e474f125459fb10
  Header: Content-Type: application/json
  Body: {"instanceId":"b0e95c28-3c1a-49f1-a262-82672e24ff14","url":"http://dead-host:9999"}
RESPONSE: HTTP 200
{
  "updated": true
}
──────────────────────────────────────

──────────────────────────────────────
REQUEST #9  02:17:31
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://dead-host:9999",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:31",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: A has stale URL for C

──────────────────────────────────────
REQUEST #9  02:17:31
GET http://nodeb:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "b6efc81b-2744-4dee-8c1e-bc307f910b57",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:30",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:27"
  },
  {
    "id": "4f5eecda-6787-4ee7-8b25-cac64b9c67d3",
    "name": "NodeA",
    "url": "http://nodea:3000",
    "instance_id": "a793cc16-a57d-4070-878d-5f75ebaaeb53",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: B still has correct URL for C

──────────────────────────────────────
REQUEST #9  02:17:31
POST http://nodea:3000/api/peers/a205d1d9-a84e-4c3a-9536-2925d4c8f261/resolve
RESPONSE: HTTP 200
{
  "resolved": true,
  "via": "NodeB",
  "peer": {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:31",
    "created_at": "2026-03-01 02:17:26"
  }
}
──────────────────────────────────────
  PASS: Gossip resolved C
  PASS: Resolved via B

──────────────────────────────────────
REQUEST #9  02:17:31
GET http://nodea:3000/api/peers
RESPONSE: HTTP 200
[
  {
    "id": "97693731-c57e-4051-8c6d-e9cfdb6e49fd",
    "name": "NodeB",
    "url": "http://nodeb:3000",
    "instance_id": "653040fd-dec6-45f0-bcce-7312d7db4313",
    "last_seen": "2026-03-01 02:17:26",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  },
  {
    "id": "a205d1d9-a84e-4c3a-9536-2925d4c8f261",
    "name": "NodeC",
    "url": "http://nodec:3000",
    "instance_id": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
    "last_seen": "2026-03-01 02:17:31",
    "auto_replicate": 0,
    "sync_library_id": null,
    "created_at": "2026-03-01 02:17:26"
  }
]
──────────────────────────────────────
  PASS: A's URL for C fixed via gossip

──────────────────────────────────────
REQUEST #9  02:17:31
GET http://nodea:3000/api/peers/a205d1d9-a84e-4c3a-9536-2925d4c8f261/library
RESPONSE: HTTP 200
{
  "instanceId": "b0e95c28-3c1a-49f1-a262-82672e24ff14",
  "instanceName": "NodeC",
  "items": []
}
──────────────────────────────────────
  PASS: A can browse C after resolve

========================================
  Results: 71/71 passed
  All tests passed!
========================================
